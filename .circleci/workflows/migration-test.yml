version: 2.1

# This workflow is triggered manually or via GitHub Actions
# It leverages shared models from .circleci/shared/

orbs:
  slack: circleci/slack@4.10.1
  keeper: gravitee-io/keeper@0.6.3

parameters:
  migration_test_from_tag:
    type: string
    default: "4.10.5"
  migration_test_to_tag:
    type: string
    default: "latest"
  migration_test_db_type:
    type: string
    default: "mongodb"
  migration_test_provider:
    type: string
    default: "k8s"

jobs:
  migration-test:
    machine:
      image: ubuntu-2204:current
      docker_layer_caching: true
    resource_class: large
    steps:
      - checkout
      - keeper/env-export:
          secret-url: keeper://YeSlq7aKxJaAFSQupb-rkA/custom_field/base64
          var-name: GRAVITEE_LICENSE_KEY
      - keeper/env-export:
          secret-url: keeper://V1A-melQB6NEckX0Uml-GQ/field/password
          var-name: CIRCLECI_TOKEN

      - run:
          name: "Install Kubernetes Tools (Kind, Kubectl, Helm)"
          command: |
            # Kind
            curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
            chmod +x ./kind
            sudo mv ./kind /usr/local/bin/kind
            # Kubectl
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            chmod +x ./kubectl
            sudo mv ./kubectl /usr/local/bin/kubectl
            # Helm
            curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - run:
          name: "1. Clean Environment"
          command: ./scripts/migration-test.mjs --from-tag << parameters.migration_test_from_tag >> --to-tag << parameters.migration_test_to_tag >> --db-type << parameters.migration_test_db_type >> --provider << parameters.migration_test_provider >> run --stage clean
      - run:
          name: "2. Deploy Source Version (<< parameters.migration_test_from_tag >>)"
          command: ./scripts/migration-test.mjs --from-tag << parameters.migration_test_from_tag >> --to-tag << parameters.migration_test_to_tag >> --db-type << parameters.migration_test_db_type >> --provider << parameters.migration_test_provider >> run --stage deploy-from
      - run:
          name: "3. Verify Baseline"
          command: ./scripts/migration-test.mjs --from-tag << parameters.migration_test_from_tag >> --to-tag << parameters.migration_test_to_tag >> --db-type << parameters.migration_test_db_type >> --provider << parameters.migration_test_provider >> run --stage verify-baseline
      - run:
          name: "4. Upgrade Management API"
          command: ./scripts/migration-test.mjs --from-tag << parameters.migration_test_from_tag >> --to-tag << parameters.migration_test_to_tag >> --db-type << parameters.migration_test_db_type >> --provider << parameters.migration_test_provider >> run --stage upgrade-mapi
      - run:
          name: "5. Verify MAPI Upgrade"
          command: ./scripts/migration-test.mjs --from-tag << parameters.migration_test_from_tag >> --to-tag << parameters.migration_test_to_tag >> --db-type << parameters.migration_test_db_type >> --provider << parameters.migration_test_provider >> run --stage verify-mapi
      - run:
          name: "6. Upgrade Gateway"
          command: ./scripts/migration-test.mjs --from-tag << parameters.migration_test_from_tag >> --to-tag << parameters.migration_test_to_tag >> --db-type << parameters.migration_test_db_type >> --provider << parameters.migration_test_provider >> run --stage upgrade-gw
      - run:
          name: "7. Final Verification"
          command: ./scripts/migration-test.mjs --from-tag << parameters.migration_test_from_tag >> --to-tag << parameters.migration_test_to_tag >> --db-type << parameters.migration_test_db_type >> --provider << parameters.migration_test_provider >> run --stage verify-all

      - notify-on-failure
      - notify-on-success

workflows:
  migration-pipeline:
    jobs:
      - migration-test
