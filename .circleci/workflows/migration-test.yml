version: 2.1

# Migration test workflow: Kind cluster + K8s provider.
# Triggered manually or via GitHub Actions. License via Keeper (GRAVITEE_LICENSE_KEY).
# When used as config-path by path-filtering, this file is self-contained (includes commands).

orbs:
  slack: circleci/slack@4.10.1
  keeper: gravitee-io/keeper@0.6.3

parameters:
  migration_test_from_tag:
    type: string
    default: "4.10.5"
  migration_test_to_tag:
    type: string
    default: "latest"
  migration_test_db_type:
    type: string
    default: "mongodb"
  migration_test_provider:
    type: string
    default: "k8s"
  migration_test_filter:
    type: string
    default: "specs/gateway/refresh-token.jest.spec"
    description: "Jest path for single-test run (e.g. one gateway e2e). Empty = full suite."

commands:
  notify-on-failure:
    steps:
      - keeper/env-export:
          secret-url: keeper://ZOz4db245GNaETVwmPBk8w/field/password
          var-name: SLACK_ACCESS_TOKEN
      - slack/notify:
          channel: C0336B2E96K
          event: fail
          mentions: "@am_team"
          template: basic_fail_1
  notify-on-success:
    steps:
      - keeper/env-export:
          secret-url: keeper://ZOz4db245GNaETVwmPBk8w/field/password
          var-name: SLACK_ACCESS_TOKEN
      - slack/notify:
          channel: C0336B2E96K
          event: pass
          template: basic_success_1

jobs:
  migration-test:
    machine:
      image: ubuntu-2204:current
      docker_layer_caching: true
    resource_class: large
    steps:
      - checkout
      - keeper/env-export:
          secret-url: keeper://YeSlq7aKxJaAFSQupb-rkA/custom_field/base64
          var-name: GRAVITEE_LICENSE_KEY
      - keeper/env-export:
          secret-url: keeper://V1A-melQB6NEckX0Uml-GQ/field/password
          var-name: CIRCLECI_TOKEN

      - run:
          name: "Install Kubernetes Tools (Kind, Kubectl, Helm)"
          command: |
            curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
            chmod +x ./kind
            sudo mv ./kind /usr/local/bin/kind
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            chmod +x ./kubectl
            sudo mv ./kubectl /usr/local/bin/kubectl
            curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - run:
          name: "Create Kind cluster"
          command: |
            kind create cluster --name am-migration --wait 2m

      - run:
          name: "1. Clean Environment"
          command: |
            export GRAVITEE_LICENSE="${GRAVITEE_LICENSE_KEY}"
            ./scripts/migration-test.mjs --from-tag << parameters.migration_test_from_tag >> --to-tag << parameters.migration_test_to_tag >> --db-type << parameters.migration_test_db_type >> --provider << parameters.migration_test_provider >> run --stage clean
      - run:
          name: "2. K8s Setup (DB + repos)"
          command: |
            export GRAVITEE_LICENSE="${GRAVITEE_LICENSE_KEY}"
            ./scripts/migration-test.mjs --from-tag << parameters.migration_test_from_tag >> --to-tag << parameters.migration_test_to_tag >> --db-type << parameters.migration_test_db_type >> --provider << parameters.migration_test_provider >> run --stage k8s:setup
      - run:
          name: "3. Deploy Source Version (<< parameters.migration_test_from_tag >>)"
          command: |
            export GRAVITEE_LICENSE="${GRAVITEE_LICENSE_KEY}"
            ./scripts/migration-test.mjs --from-tag << parameters.migration_test_from_tag >> --to-tag << parameters.migration_test_to_tag >> --db-type << parameters.migration_test_db_type >> --provider << parameters.migration_test_provider >> run --stage deploy-from
      - run:
          name: "4. Verify Baseline"
          command: |
            export GRAVITEE_LICENSE="${GRAVITEE_LICENSE_KEY}"
            ./scripts/migration-test.mjs --from-tag << parameters.migration_test_from_tag >> --to-tag << parameters.migration_test_to_tag >> --db-type << parameters.migration_test_db_type >> --provider << parameters.migration_test_provider >> --test-filter "<< parameters.migration_test_filter >>" run --stage verify-baseline
      - run:
          name: "5. Upgrade Management API"
          command: |
            export GRAVITEE_LICENSE="${GRAVITEE_LICENSE_KEY}"
            ./scripts/migration-test.mjs --from-tag << parameters.migration_test_from_tag >> --to-tag << parameters.migration_test_to_tag >> --db-type << parameters.migration_test_db_type >> --provider << parameters.migration_test_provider >> run --stage upgrade-mapi
      - run:
          name: "6. Verify MAPI Upgrade"
          command: |
            export GRAVITEE_LICENSE="${GRAVITEE_LICENSE_KEY}"
            ./scripts/migration-test.mjs --from-tag << parameters.migration_test_from_tag >> --to-tag << parameters.migration_test_to_tag >> --db-type << parameters.migration_test_db_type >> --provider << parameters.migration_test_provider >> --test-filter "<< parameters.migration_test_filter >>" run --stage verify-mapi
      - run:
          name: "7. Upgrade Gateway"
          command: |
            export GRAVITEE_LICENSE="${GRAVITEE_LICENSE_KEY}"
            ./scripts/migration-test.mjs --from-tag << parameters.migration_test_from_tag >> --to-tag << parameters.migration_test_to_tag >> --db-type << parameters.migration_test_db_type >> --provider << parameters.migration_test_provider >> run --stage upgrade-gw
      - run:
          name: "8. Final Verification (gateway e2e)"
          command: |
            export GRAVITEE_LICENSE="${GRAVITEE_LICENSE_KEY}"
            ./scripts/migration-test.mjs --from-tag << parameters.migration_test_from_tag >> --to-tag << parameters.migration_test_to_tag >> --db-type << parameters.migration_test_db_type >> --provider << parameters.migration_test_provider >> --test-filter "<< parameters.migration_test_filter >>" run --stage verify-all

      - notify-on-failure
      - notify-on-success

workflows:
  migration-pipeline:
    jobs:
      - migration-test
