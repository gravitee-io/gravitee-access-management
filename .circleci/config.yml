version: 2.1

parameters:
  gio_action:
    type: enum
    enum: [release, publish_rpms, pull_requests]
    default: pull_requests
  dry_run:
    type: boolean
    default: true
    description: "Run in dry run mode?"
  maven_profile_id:
    type: string
    default: "gravitee-dry-run"
    description: "Maven ID of the Maven profile to use for a dry run ?"
  ee_id_provider_cas_version:
    type: string
    default: $ID_PROVIDER_CAS_VERSION
    description: "For Gravitee AM Release : The semver version number of the CAS identity provider plugin to bundle with GRavitee AM Entreprise Edition"
  ee_id_provider_kerberos_version:
    type: string
    default: $ID_PROVIDER_KERBEROS_VERSION
    description: "For Gravitee AM Release : The semver version number of the Kerberos identity provider plugin to bundle with GRavitee AM Entreprise Edition"
  ee_id_provider_saml_version:
    type: string
    default: $ID_PROVIDER_SAML_VERSION
    description: "For Gravitee AM Release : The semver version number of the SAML2 identity provider plugin to bundle with GRavitee AM Entreprise Edition"
  ee_gravitee_license_version:
    type: string
    default: $ID_PROVIDER_SAML_VERSION
    description: "The semver version number of the Gravitee License to bundle with Gravitee AM Entreprise Edition"
  secrethub_org:
    type: string
    default: "gravitee-lab"
    description: "SecretHub Org to use to fetch secrets ?"
  secrethub_repo:
    type: string
    default: "cicd"
    description: "SecretHub Repo to use to fetch secrets ?"
  graviteeio_version:
    type: string
    default: "cicd"
    description: "Release version number to use to publish the Docker nightly images ?"

orbs:
  gravitee: gravitee-io/gravitee@dev:1.0.4
  secrethub: secrethub/cli@1.1.0

# --- Jobs to perform all workflows
# jobs:


workflows:
  version: 2.1
  # -- typically this workflow is executed on pull requests events for Community Edition Gravitee Repositories
  pull_requests:
    when:
      and:
        - equal: [ pull_requests, << pipeline.parameters.gio_action >> ]
    jobs:
      - gravitee/d_pull_requests_secrets:
          context: cicd-orchestrator
          name: pr_secrets_resolution
      - gravitee/d_pull_requests_ce:
          name: process_pull_request
          requires:
            - pr_secrets_resolution
          # "What is the maven ID of the maven profile to use to build and deploy SNAPSHOTS to Prviate Artifactory ?"
          maven_profile_id: 'gio-dev'
          # nexus_snapshots_url: 'https://oss.sonatype.org/content/repositories/snapshots'
          # nexus_snapshots_server_id: 'sonatype-nexus-snapshots'
          # container_gun_image_org: 'circleci'
          # container_gun_image_name: 'openjdk'
          # container_gun_image_tag: '11.0.3-jdk-stretch'
          container_size: 'xlarge'
          filters:
            branches:
              ignore:
                - master
                # - /^[0-999].[0-999].x/ # Ignore support branches, because they are checked with noightly ? Would make sense...



  release:
    when:
      and:
        - equal: [ release, << pipeline.parameters.gio_action >> ]
        - not : << pipeline.parameters.dry_run >>
    jobs:
      - gravitee/d_am_release_secrets:
          context: cicd-orchestrator
          name: 'am_release_secrets'
      - gravitee/d_am_release:
          requires:
            - am_release_secrets
          dry_run: << pipeline.parameters.dry_run >>
          maven_profile_id: 'gio-release'
          # ee_id_provider_cas_version: << pipeline.parameters.ee_id_provider_cas_version >>
          # ee_id_provider_kerberos_version: << pipeline.parameters.ee_id_provider_kerberos_version >>
          ee_id_provider_saml_version: << pipeline.parameters.ee_id_provider_saml_version >>
          ee_gravitee_license_version: << pipeline.parameters.ee_gravitee_license_version >>

  release_dry_run:
    when:
      and:
        - equal: [ release, << pipeline.parameters.gio_action >> ]
        - << pipeline.parameters.dry_run >>
    jobs:
      - gravitee/d_am_release_secrets:
          context: cicd-orchestrator
          name: 'am_release_secrets'
      - gravitee/d_am_release:
          requires:
            - am_release_secrets
          dry_run: << pipeline.parameters.dry_run >>
          maven_profile_id: 'gravitee-dry-run'
          # ee_id_provider_cas_version: << pipeline.parameters.ee_id_provider_cas_version >>
          # ee_id_provider_kerberos_version: << pipeline.parameters.ee_id_provider_kerberos_version >>
          ee_id_provider_saml_version: << pipeline.parameters.ee_id_provider_saml_version >>
          ee_gravitee_license_version: << pipeline.parameters.ee_gravitee_license_version >>



  docker_nightly:
    triggers:
      - schedule:
          cron: "0 0 * * *"
          filters:
            branches:
              only:
                - master
                - /^[0-999].[0-999].x/
                - cicd/circleci-release
    jobs:
      - gravitee/d_am_nightly_secrets:
          context: cicd-orchestrator
          name: nightly_secrets_resolution
      - gravitee/d_am_nightly:
          name: docker_nightly
          requires:
            - nightly_secrets_resolution
          container_size: 'xlarge'
#
  publish_rpms:
    when:
      equal: [ publish_rpms, << pipeline.parameters.gio_action >> ]
    jobs:
      - gravitee/publish_am_rpms:
          context: cicd-orchestrator
          secrethub_org: graviteeio
          secrethub_repo: cicd
          gio_release_version: << pipeline.parameters.graviteeio_version >>
