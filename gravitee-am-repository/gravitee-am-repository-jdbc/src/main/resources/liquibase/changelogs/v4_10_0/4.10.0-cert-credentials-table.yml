databaseChangeLog:
  - changeSet:
      id: 4.10.0-cert-credentials-table
      author: GraviteeSource Team
      preConditions:
        onFail: MARK_RAN
        not:
          - tableExists:
              tableName: cert_credentials
      changes:
        - createTable:
            tableName: cert_credentials
            columns:
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: pk_cert_credentials
                  name: id
                  type: VARCHAR(64)
              - column:
                  constraints:
                    nullable: false
                  name: reference_type
                  type: VARCHAR(64)
              - column:
                  constraints:
                    nullable: false
                  name: reference_id
                  type: VARCHAR(255)
              - column:
                  name: user_id
                  type: VARCHAR(64)
              - column:
                  name: username
                  type: VARCHAR(320)
              - column:
                  name: ip_address
                  type: VARCHAR(255)
              - column:
                  name: user_agent
                  type: VARCHAR(255)
              - column:
                  name: device_name
                  type: VARCHAR(255)
              - column:
                  constraints:
                    nullable: false
                  name: certificate_pem
                  type: TEXT
              - column:
                  constraints:
                    nullable: false
                  name: certificate_thumbprint
                  type: VARCHAR(64)
              - column:
                  constraints:
                    nullable: false
                  name: certificate_subject_dn
                  type: VARCHAR(512)
              - column:
                  constraints:
                    nullable: false
                  name: certificate_serial_number
                  type: VARCHAR(128)
              - column:
                  constraints:
                    nullable: false
                  name: certificate_expires_at
                  type: TIMESTAMP(6)
              - column:
                  name: metadata
                  type: TEXT
              - column:
                  constraints:
                    nullable: false
                  name: created_at
                  type: TIMESTAMP(6)
              - column:
                  constraints:
                    nullable: false
                  name: updated_at
                  type: TIMESTAMP(6)
              - column:
                  name: accessed_at
                  type: TIMESTAMP(6)

  - changeSet:
      id: 4.10.0-cert-credentials-index-ref-userid
      author: GraviteeSource Team
      preConditions:
        onFail: MARK_RAN
        not:
          - indexExists:
              indexName: idx_cert_credentials_ref_userid
              tableName: cert_credentials
      changes:
        - createIndex:
            columns:
              - column:
                  name: reference_id
              - column:
                  name: reference_type
              - column:
                  name: user_id
            indexName: idx_cert_credentials_ref_userid
            tableName: cert_credentials

  - changeSet:
      id: 4.10.0-cert-credentials-index-ref-thumbprint
      author: GraviteeSource Team
      preConditions:
        onFail: MARK_RAN
        not:
          - indexExists:
              indexName: idx_cert_credentials_ref_thumbprint
              tableName: cert_credentials
      changes:
        - createIndex:
            columns:
              - column:
                  name: reference_id
              - column:
                  name: reference_type
              - column:
                  name: certificate_thumbprint
            indexName: idx_cert_credentials_ref_thumbprint
            tableName: cert_credentials

  - changeSet:
      id: 4.10.0-cert-credentials-index-ref-subjectdn
      author: GraviteeSource Team
      preConditions:
        onFail: MARK_RAN
        not:
          - indexExists:
              indexName: idx_cert_credentials_ref_subjectdn
              tableName: cert_credentials
      changes:
        - createIndex:
            columns:
              - column:
                  name: reference_id
              - column:
                  name: reference_type
              - column:
                  name: certificate_subject_dn
            indexName: idx_cert_credentials_ref_subjectdn
            tableName: cert_credentials

  - changeSet:
      id: 4.10.0-cert-credentials-index-ref-serial
      author: GraviteeSource Team
      preConditions:
        onFail: MARK_RAN
        not:
          - indexExists:
              indexName: idx_cert_credentials_ref_serial
              tableName: cert_credentials
      changes:
        - createIndex:
            columns:
              - column:
                  name: reference_id
              - column:
                  name: reference_type
              - column:
                  name: certificate_serial_number
            indexName: idx_cert_credentials_ref_serial
            tableName: cert_credentials

  - changeSet:
      id: 4.10.0-cert-credentials-index-expires-at
      author: GraviteeSource Team
      preConditions:
        onFail: MARK_RAN
        not:
          - indexExists:
              indexName: idx_cert_credentials_expires_at
              tableName: cert_credentials
      changes:
        - createIndex:
            columns:
              - column:
                  name: certificate_expires_at
            indexName: idx_cert_credentials_expires_at
            tableName: cert_credentials

