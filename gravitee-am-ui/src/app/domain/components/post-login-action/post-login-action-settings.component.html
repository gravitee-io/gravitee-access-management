<!--

    Copyright (C) 2015 The Gravitee team (http://gravitee.io)

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

            http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->
<form (ngSubmit)="save()" fxLayout="column" #postLoginActionForm="ngForm">
  <div *ngIf="inheritMode" fxLayout="column" class="gv-form-section">
    <div fxLayout="column">
      <mat-slide-toggle (change)="enableInheritMode($event)" [checked]="isInherited()" [disabled]="readonly">
        Inherit configuration
      </mat-slide-toggle>
      <mat-hint style="font-size: 75%">Inherit Post Login Action settings from the security domain.</mat-hint>
    </div>
  </div>

  <div *ngIf="!inheritMode || !postLoginAction.inherited">
    <div class="gv-form-section">
      <div class="gv-form-section-title">
        <h5>Post Login Action</h5>
        <mat-divider></mat-divider>
      </div>
      <div fxLayout="column">
        <mat-slide-toggle (change)="toggleEnabled($event)" [checked]="isEnabled()" [disabled]="readonly">
          Enable post login action
        </mat-slide-toggle>
        <mat-hint style="font-size: 75%">Redirect users to an external verification service after login.</mat-hint>
      </div>
      <div fxLayout="column" style="margin-top: 10px">
        <mat-form-field appearance="outline" floatLabel="always">
          <mat-label>External service URL</mat-label>
          <input
            matInput
            type="url"
            name="postLoginActionUrl"
            #postLoginActionUrlCtrl="ngModel"
            [ngModel]="postLoginAction.url"
            (ngModelChange)="setUrl($event)"
            [required]="isEnabled()"
            [pattern]="httpsUrlPattern"
            [disabled]="readonly || !isEnabled()"
          />
          <mat-hint>URL of the external service that receives the state JWT.</mat-hint>
          <mat-error *ngIf="postLoginActionUrlCtrl.hasError('required')">
            External service URL is required when post login action is enabled.
          </mat-error>
          <mat-error *ngIf="!postLoginActionUrlCtrl.hasError('required') && postLoginActionUrlCtrl.invalid">
            Provide a valid URL (for example, https://verify.example.com/action).
          </mat-error>
        </mat-form-field>
      </div>
      <div fxLayout="column" style="margin-top: 10px">
        <mat-form-field appearance="outline" floatLabel="always">
          <mat-label>State JWT signing certificate</mat-label>
          <mat-select
            name="certificateId"
            [ngModel]="postLoginAction.certificateId"
            (ngModelChange)="setCertificateId($event)"
            [disabled]="readonly || !isEnabled()"
          >
            <mat-option [value]="null">Default certificate</mat-option>
            <mat-option *ngFor="let certificate of certificates" [value]="certificate.id">{{ certificate.name }}</mat-option>
          </mat-select>
          <mat-hint>Certificate used to sign the state JWT sent to the external service.</mat-hint>
        </mat-form-field>
      </div>
      <div fxLayout="column" style="margin-top: 10px">
        <mat-form-field appearance="outline" floatLabel="always">
          <mat-label>Timeout (milliseconds)</mat-label>
          <input
            matInput
            type="number"
            name="timeout"
            [ngModel]="postLoginAction.timeout"
            (ngModelChange)="setTimeout($event)"
            [min]="0"
            [required]="isEnabled()"
            [disabled]="readonly || !isEnabled()"
          />
          <mat-hint>Time allowed for the external service to respond.</mat-hint>
        </mat-form-field>
      </div>
    </div>

    <div class="gv-form-section">
      <div class="gv-form-section-title">
        <h5>Response validation</h5>
        <mat-divider></mat-divider>
      </div>
      <div fxLayout="column">
        <mat-form-field appearance="outline" floatLabel="always">
          <mat-label>Response public key (PEM)</mat-label>
          <textarea
            matInput
            rows="5"
            name="responsePublicKey"
            #responsePublicKeyCtrl="ngModel"
            [ngModel]="postLoginAction.responsePublicKey"
            (ngModelChange)="setResponsePublicKey($event)"
            [required]="isEnabled()"
            [disabled]="readonly || !isEnabled()"
          ></textarea>
          <mat-hint>Public key used to validate the JWT response from the external service.</mat-hint>
          <mat-error *ngIf="responsePublicKeyCtrl.hasError('required')">
            Response public key is required when post login action is enabled.
          </mat-error>
        </mat-form-field>
      </div>
      <div fxLayout="column" style="margin-top: 10px">
        <mat-form-field appearance="outline" floatLabel="always">
          <mat-label>Response token parameter</mat-label>
          <input
            matInput
            type="text"
            name="responseTokenParam"
            [ngModel]="postLoginAction.responseTokenParam"
            (ngModelChange)="setResponseTokenParam($event)"
            [disabled]="readonly || !isEnabled()"
          />
          <mat-hint>Query parameter name that contains the JWT response from the external service.</mat-hint>
        </mat-form-field>
      </div>
    </div>

    <div class="gv-form-section">
      <div class="gv-form-section-title">
        <h5>Response claims</h5>
        <mat-divider></mat-divider>
      </div>
      <div fxLayout="column">
        <mat-form-field appearance="outline" floatLabel="always">
          <mat-label>Success claim</mat-label>
          <input
            matInput
            type="text"
            name="successClaim"
            [ngModel]="postLoginAction.successClaim"
            (ngModelChange)="setSuccessClaim($event)"
            [disabled]="readonly || !isEnabled()"
          />
          <mat-hint>Claim used to signal a successful verification.</mat-hint>
        </mat-form-field>
      </div>
      <div fxLayout="column" style="margin-top: 10px">
        <mat-form-field appearance="outline" floatLabel="always">
          <mat-label>Success value</mat-label>
          <input
            matInput
            type="text"
            name="successValue"
            [ngModel]="postLoginAction.successValue"
            (ngModelChange)="setSuccessValue($event)"
            [disabled]="readonly || !isEnabled()"
          />
          <mat-hint>Expected value in the success claim.</mat-hint>
        </mat-form-field>
      </div>
      <div fxLayout="column" style="margin-top: 10px">
        <mat-form-field appearance="outline" floatLabel="always">
          <mat-label>Error claim</mat-label>
          <input
            matInput
            type="text"
            name="errorClaim"
            [ngModel]="postLoginAction.errorClaim"
            (ngModelChange)="setErrorClaim($event)"
            [disabled]="readonly || !isEnabled()"
          />
          <mat-hint>Claim that carries error information when the action is denied.</mat-hint>
        </mat-form-field>
      </div>
      <div fxLayout="column" style="margin-top: 10px">
        <mat-form-field appearance="outline" floatLabel="always">
          <mat-label>Data claim</mat-label>
          <input
            matInput
            type="text"
            name="dataClaim"
            [ngModel]="postLoginAction.dataClaim"
            (ngModelChange)="setDataClaim($event)"
            [disabled]="readonly || !isEnabled()"
          />
          <mat-hint>Claim name used to attach additional data to the response.</mat-hint>
        </mat-form-field>
      </div>
    </div>
  </div>

  <div fxLayout="row" *ngIf="!readonly">
    <button mat-raised-button color="primary" [disabled]="!formChanged || !isFormValid()" type="submit">SAVE</button>
  </div>
</form>
