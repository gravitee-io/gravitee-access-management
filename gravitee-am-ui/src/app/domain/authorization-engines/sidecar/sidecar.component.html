<!--

    Copyright (C) 2015 The Gravitee team (http://gravitee.io)

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

            http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->
<div class="gv-page-container">
  <div class="page-header">
    <div class="page-header__title">
      <img *ngIf="plugin?.icon" [src]="plugin.icon" class="page-header__icon" [alt]="plugin.displayName || plugin.name" />
      <h1 class="page-header__text">{{ authorizationEngine?.name || plugin?.displayName || 'Sidecar Authorization Engine' }}</h1>
    </div>
    <div class="page-header__details" *ngIf="healthStatus !== null">
      <div class="page-header__details-item">
        <span class="label">Sidecar Status</span>
        <span class="value">
          <span class="health-indicator" [class.health-up]="healthReady" [class.health-down]="!healthReady">
            <mat-icon>{{ healthReady ? 'check_circle' : 'error' }}</mat-icon>
            <span>{{ healthStatus }}</span>
          </span>
        </span>
      </div>
      <div class="page-header__details-item" *ngIf="connectedSidecars !== null">
        <span class="label">Connected Sidecars</span>
        <span class="value">{{ connectedSidecars }}</span>
      </div>
    </div>
  </div>

  <div class="gv-page-description">Manage your AuthZEN sidecar settings.</div>

  <mat-tab-group [dynamicHeight]="true">
    <!-- Health Tab -->
    <mat-tab label="Health">
      <div fxLayout="row" fxLayoutGap="20px">
        <div fxLayout="column" fxFlex="70">
          <div class="gv-form-section">
            <div class="gv-form-section-title">
              <h5>Sidecar Health</h5>
              <mat-divider></mat-divider>
            </div>

            <div class="health-card" *ngIf="healthStatus !== null && !isCheckingHealth">
              <div class="health-status" [class.health-up]="healthReady" [class.health-down]="!healthReady">
                <mat-icon class="health-icon">{{ healthReady ? 'check_circle' : 'error' }}</mat-icon>
                <div class="health-info">
                  <span class="health-label">{{ healthStatus }}</span>
                  <span class="health-detail" *ngIf="healthReady">
                    {{ connectedSidecars }} sidecar(s) connected. Bundle version: {{ bundleVersion }}.
                  </span>
                  <span class="health-detail" *ngIf="healthStatus === 'AWAITING_CONNECTION'">No sidecar is currently connected via WebSocket. Start a sidecar and verify the API key and domain path.</span>
                  <span class="health-detail" *ngIf="healthStatus === 'UNREACHABLE'">Cannot reach the gateway health endpoint. Check that the gateway is running.</span>
                  <span class="health-detail" *ngIf="healthStatus === 'DOWN'">The gateway reported an unhealthy status.</span>
                </div>
              </div>
            </div>

            <div *ngIf="isCheckingHealth" class="health-loading">
              <mat-progress-spinner [diameter]="24" [strokeWidth]="3" mode="indeterminate"></mat-progress-spinner>
              <span>Checking sidecar health...</span>
            </div>

            <div class="health-actions">
              <button mat-raised-button color="primary" (click)="checkHealth()" [disabled]="isCheckingHealth">
                <mat-icon>refresh</mat-icon>
                Refresh
              </button>
            </div>
          </div>
        </div>
        <div class="gv-page-description" fxFlex="30">
          <h3>Sidecar Health</h3>
          <div class="gv-page-description-content">
            <p>Shows the status of sidecars connected to the gateway via WebSocket.</p>
            <small>Status Values</small>
            <ul>
              <li><strong>UP</strong> - At least one sidecar is connected and receiving policy bundles</li>
              <li><strong>AWAITING_CONNECTION</strong> - No sidecar has connected yet</li>
              <li><strong>UNREACHABLE</strong> - Cannot communicate with the gateway</li>
            </ul>
            <p>Policy and entity data are managed through Authorization Bundles and pushed to sidecars automatically over the WebSocket connection.</p>
          </div>
        </div>
      </div>
    </mat-tab>

    <!-- Configuration Tab -->
    <mat-tab label="Configuration">
      <div fxLayout="row" fxLayoutGap="20px">
        <div fxLayout="column" fxFlex="70">
          <div class="gv-form-section">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Name</mat-label>
              <input matInput type="text" placeholder="Name" [(ngModel)]="authorizationEngine.name" required />
              <mat-hint>Authorization engine name</mat-hint>
            </mat-form-field>
          </div>

          <div class="gv-form-section">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Domain Path</mat-label>
              <input matInput type="text" [value]="domainPath" disabled />
              <mat-hint>The domain path used in the WebSocket URL. Sidecars connect to <code>/&lt;domain-path&gt;/_authz/ws</code>.</mat-hint>
            </mat-form-field>
          </div>

          <div class="gv-form-section">
            <div class="gv-form-section-title">
              <h5>Authorization Bundle</h5>
              <mat-divider></mat-divider>
            </div>
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Authorization Bundle</mat-label>
              <mat-select [(ngModel)]="selectedBundleId" (ngModelChange)="onBundleChanged()">
                <mat-option value="">-- None --</mat-option>
                <mat-option *ngFor="let bundle of bundles" [value]="bundle.id">{{ bundle.name }}</mat-option>
              </mat-select>
              <mat-hint>Select the Authorization Bundle whose policies, entities, and schema will be served to connected sidecars.</mat-hint>
            </mat-form-field>
          </div>

          <info-banner
            type="warning"
            text="Gateway is currently not reachable. Please review the configuration."
            [showButton]="false"
            *ngIf="hasLoadError"
          ></info-banner>

          <div class="gv-form-section">
            <div class="gv-form-section-title">
              <h5>Connection Settings</h5>
              <mat-divider></mat-divider>
            </div>
            <provider-form
              [providerConfiguration]="configuration"
              [providerSchema]="configurationSchema"
              (configurationCompleted)="onConfigurationChanged($event)"
            >
            </provider-form>
          </div>

          <div fxLayout="row">
            <button
              mat-raised-button
              color="primary"
              (click)="saveConfiguration()"
              [disabled]="!isConfigurationDirty() || !configurationIsValid || isSaving"
            >
              <span class="gv-button-content">
                <mat-progress-spinner *ngIf="isSaving" [diameter]="16" [strokeWidth]="2" mode="indeterminate"></mat-progress-spinner>
                <span>{{ isSaving ? 'Saving...' : 'SAVE' }}</span>
              </span>
            </button>
          </div>
        </div>
        <div class="gv-page-description" fxFlex="30">
          <h3>Sidecar Configuration</h3>
          <div class="gv-page-description-content">
            <p>Configure the WebSocket connection between the gateway and AuthZEN sidecars.</p>
            <small>Connection Setup</small>
            <p>Sidecars connect to the gateway at <code>/&lt;domain-path&gt;/_authz/ws</code> using:</p>
            <ul>
              <li><strong>Domain Path</strong> - Routes the WebSocket to the correct security domain</li>
              <li><strong>API Key</strong> - Authenticates the sidecar connection</li>
              <li><strong>Bundle</strong> - Determines which policies are served</li>
            </ul>
            <small>Sidecar Environment Variables</small>
            <ul>
              <li><code>GATEWAY_URL</code> - Gateway base URL</li>
              <li><code>SIDECAR_DOMAIN_PATH</code> - Domain path shown above</li>
              <li><code>SIDECAR_API_KEY</code> - API Key configured below</li>
            </ul>
          </div>
        </div>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>
