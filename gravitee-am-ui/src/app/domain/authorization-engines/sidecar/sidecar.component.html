<!--

    Copyright (C) 2015 The Gravitee team (http://gravitee.io)

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

            http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->
<div class="gv-page-container">
  <div class="page-header">
    <div class="page-header__title">
      <img *ngIf="plugin?.icon" [src]="plugin.icon" class="page-header__icon" [alt]="plugin.displayName || plugin.name" />
      <h1 class="page-header__text">{{ authorizationEngine?.name || plugin?.displayName || 'Sidecar Authorization Engine' }}</h1>
    </div>
    <div class="page-header__details" *ngIf="healthStatus !== null">
      <div class="page-header__details-item">
        <span class="label">Sidecar Status</span>
        <span class="value">
          <span class="health-indicator" [class.health-up]="healthReady" [class.health-down]="!healthReady">
            <mat-icon>{{ healthReady ? 'check_circle' : 'error' }}</mat-icon>
            <span>{{ healthStatus }}</span>
          </span>
        </span>
      </div>
    </div>
  </div>

  <div class="gv-page-description">Manage your AuthZEN sidecar settings.</div>

  <mat-tab-group [dynamicHeight]="true">
    <!-- Health Tab -->
    <mat-tab label="Health">
      <div fxLayout="row" fxLayoutGap="20px">
        <div fxLayout="column" fxFlex="70">
          <div class="gv-form-section">
            <div class="gv-form-section-title">
              <h5>Sidecar Health</h5>
              <mat-divider></mat-divider>
            </div>

            <div class="health-card" *ngIf="healthStatus !== null && !isCheckingHealth">
              <div class="health-status" [class.health-up]="healthReady" [class.health-down]="!healthReady">
                <mat-icon class="health-icon">{{ healthReady ? 'check_circle' : 'error' }}</mat-icon>
                <div class="health-info">
                  <span class="health-label">{{ healthStatus }}</span>
                  <span class="health-detail" *ngIf="healthReady">The sidecar is running and has a policy loaded.</span>
                  <span class="health-detail" *ngIf="healthStatus === 'AWAITING_POLICY'">The sidecar is running but no policy has been deployed yet.</span>
                  <span class="health-detail" *ngIf="healthStatus === 'UNREACHABLE'">Cannot connect to the sidecar. Check that it is running and the URL is correct.</span>
                  <span class="health-detail" *ngIf="healthStatus === 'DOWN'">The sidecar reported an unhealthy status.</span>
                </div>
              </div>
            </div>

            <div *ngIf="isCheckingHealth" class="health-loading">
              <mat-progress-spinner [diameter]="24" [strokeWidth]="3" mode="indeterminate"></mat-progress-spinner>
              <span>Checking sidecar health...</span>
            </div>

            <div class="health-actions">
              <button mat-raised-button color="primary" (click)="checkHealth()" [disabled]="isCheckingHealth">
                <mat-icon>refresh</mat-icon>
                Refresh
              </button>
            </div>
          </div>
        </div>
        <div class="gv-page-description" fxFlex="30">
          <h3>Sidecar Health</h3>
          <div class="gv-page-description-content">
            <p>Shows the current status of the connected AuthZEN sidecar.</p>
            <small>Status Values</small>
            <ul>
              <li><strong>UP</strong> - Sidecar is running with a policy deployed</li>
              <li><strong>AWAITING_POLICY</strong> - Sidecar is running but waiting for policy deployment</li>
              <li><strong>UNREACHABLE</strong> - Cannot connect to the sidecar</li>
            </ul>
            <p>Policy and entity data are managed through Authorization Bundles and pushed to the sidecar automatically.</p>
          </div>
        </div>
      </div>
    </mat-tab>

    <!-- Configuration Tab -->
    <mat-tab label="Configuration">
      <div fxLayout="row" fxLayoutGap="20px">
        <div fxLayout="column" fxFlex="70">
          <div class="gv-form-section">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Name</mat-label>
              <input matInput type="text" placeholder="Name" [(ngModel)]="authorizationEngine.name" required />
              <mat-hint>Authorization engine name</mat-hint>
            </mat-form-field>
          </div>

          <info-banner
            type="warning"
            text="Sidecar is currently not reachable. Please review the configuration."
            [showButton]="false"
            *ngIf="hasLoadError"
          ></info-banner>

          <div class="gv-form-section">
            <div class="gv-form-section-title">
              <h5>Configuration</h5>
              <mat-divider></mat-divider>
            </div>
            <provider-form
              [providerConfiguration]="configuration"
              [providerSchema]="configurationSchema"
              (configurationCompleted)="onConfigurationChanged($event)"
            >
            </provider-form>
          </div>

          <div fxLayout="row">
            <button
              mat-raised-button
              color="primary"
              (click)="saveConfiguration()"
              [disabled]="!isConfigurationDirty() || !configurationIsValid || isSaving"
            >
              <span class="gv-button-content">
                <mat-progress-spinner *ngIf="isSaving" [diameter]="16" [strokeWidth]="2" mode="indeterminate"></mat-progress-spinner>
                <span>{{ isSaving ? 'Saving...' : 'SAVE' }}</span>
              </span>
            </button>
          </div>
        </div>
        <div class="gv-page-description" fxFlex="30">
          <h3>Sidecar Configuration</h3>
          <div class="gv-page-description-content">
            <p>Configure the connection to your AuthZEN sidecar instance.</p>
            <small>Troubleshooting</small>
            <p>If connection fails, verify:</p>
            <ul>
              <li>Sidecar URL is reachable from the gateway</li>
              <li>The sidecar process is running</li>
              <li>Port is not blocked by a firewall</li>
            </ul>
          </div>
        </div>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>
