<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MFA Enroll</title>
    <!-- CSS -->
    <link rel="stylesheet" th:href="@{../assets/css/intl-tel-input.css}">
    <link rel="stylesheet" th:href="@{../assets/css/main.css}">

    <!-- Favicon and touch icons -->
    <link rel="shortcut icon" th:href="${theme.faviconUrl} ?: @{../assets/ico/favicon.ico}">

    <!-- Custom CSS -->
    <style th:if="${theme.css}" th:text="${theme.css}"></style>
    <style th:if="${theme.customCss}" th:text="${theme.customCss}"></style>
</head>
<body>
<div class="container">
    <div class="header">
        <img class="logo" th:src="${theme.logoUrl} ?: @{../assets/images/gravitee-logo.svg}">
        <div class="title">
            <span id="enrollment-title" th:text="#{mfa_enroll.title}"/>
        </div>
        <div class="header-description">
            <span id="enrollment-description" th:text="#{mfa_enroll.description}"/>
        </div>
    </div>
    <div id="enrollments" class="section card-section">
        <div th:each="factor,factIter : ${factors}">
            <div th:if="${factor.factorType == 'TOTP'}" class="radio-card">
                <div class="card-content">
                    <div class="radio">
                        <input type="radio" name="otp" value="otp">
                    </div>
                    <div class="radio-detail">
                        <span class="enroll-name" th:text="#{mfa.otp}"/>
                        <span class="enroll-description" th:text="#{mfa_enroll.otp.description}"/>
                    </div>
                </div>
            </div>

            <div th:if="${factor.factorType == 'SMS' || factor.factorType == 'CALL'}" class="radio-card">
                <div class="card-content">
                    <div class="radio">
                        <input type="radio" name="sms" value="sms">
                    </div>
                    <div class="radio-detail">
                        <span class="enroll-name" th:text="#{mfa.sms}"/>
                        <span class="enroll-description" th:text="#{mfa_enroll.sms.description}"/>
                    </div>
                </div>
            </div>

            <div th:if="${factor.factorType == 'EMAIL'}" class="radio-card">
                <div class="card-content">
                    <div class="radio">
                        <input type="radio" name="email" value="email">
                    </div>
                    <div class="radio-detail">
                        <span class="enroll-name" th:text="#{mfa.email}"/>
                        <span class="enroll-description" th:text="#{mfa_enroll.email.description}"/>
                    </div>
                </div>
            </div>

            <div th:if="${factor.factorType == 'HTTP'}" class="radio-card">
                <div class="card-content">
                    <div class="radio">
                        <input type="radio" name="http" value="http">
                    </div>
                    <div class="radio-detail">
                        <span class="enroll-name" th:text="#{mfa.http}"/>
                        <span class="enroll-description" th:text="#{mfa_enroll.http.description}"/>
                    </div>
                </div>
            </div>

            <div th:if="${factor.factorType == 'FIDO2'}" class="radio-card">
                <div class="card-content">
                    <div class="radio">
                        <input type="radio" name="fido2" value="fido2">
                    </div>
                    <div class="radio-detail">
                        <span class="enroll-name" th:text="#{mfa.fido}"></span>
                        <span class="enroll-description" th:text="#{mfa_enroll.fido.description}"></span>
                    </div>
                </div>
            </div>
        </div>
        <div>
            <button id="next" class="button primary" th:text="#{mfa_enroll.button.submit}"></button>
        </div>

        <form role="form" th:action="${action}" method="post" class="form">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <div>
                <button type="submit" name="user_mfa_enrollment" value="false" class="button secondary" th:text="#{mfa_enroll.button.skip}"></button>
            </div>
        </form>
    </div>
    <div th:id="'fact' + ${factIter.index}" th:each="factor,factIter : ${factors}" class="hide-enrollment-item">
        <div th:if="${factor.factorType == 'TOTP'}" id="otp" class="section">
            <form role="form" th:id="${factor.id}" th:action="${action}" method="post" class="enrollment-card">
                <span class="enrollment-card-label" th:text="#{mfa.otp}"/>
                <span class="enrollment-card-description otp-card-description" th:text="#{mfa_enroll.otp}"/>

                <div class="otp-container">
                    <img th:src="${factor.enrollment.barCode}"/>
                </div>

                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <input type="hidden" th:id="'sharedSecret' + ${factIter.index}" th:name="'sharedSecret' + ${factIter.index}" th:value="${factor.enrollment.key}"/>
                <input type="hidden" th:name="factorId" th:value="${factor.id}"/>
                <input type="hidden" id="sharedSecret" name="sharedSecret" value=""/>
                <div>
                    <button th:id="'submit' + ${factor.id}" type="submit" name="user_mfa_enrollment" value="true" class="button primary" th:text="#{mfa_enroll.button.submit}"></button>
                </div>
                <div>
                    <button type="submit" name="user_mfa_enrollment" value="false" class="button secondary" th:text="#{mfa_enroll.button.skip}"></button>
                </div>
            </form>

            <div class="section">
                <a class="left-arrow" href="#"><span class="icons">arrow_back</span><span th:text="#{mfa_enroll.button.back}"></span></a>
            </div>
        </div>
        <div th:if="${factor.factorType == 'SMS' || factor.factorType == 'CALL'}" id="sms" class="section">
            <form role="form" th:id="${factor.id}" th:action="${action}" method="post" class="enrollment-card">
                <span class="enrollment-card-label" th:text="#{mfa.sms}"/>
                <span class="enrollment-card-description" th:text="#{mfa_enroll.sms}"/>
                <input class="input-field" th:id="'phoneFact' + ${factIter.index}" type="tel" th:name="'phoneFact' + ${factIter.index}" th:value="${phoneNumber}">

                <div th:id="'invalidphoneFact' + ${factIter.index}" class="button error-text">
                    <span class="description">
                        <span class="error" th:text="${error}"></span>
                        <small th:text="#{mfa_enroll.call}"></small>
                    </span>
                </div>

                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <input type="hidden" th:name="factorId" th:value="${factor.id}"/>
                <input type="hidden" id="phone" name="phone" value=""/>
                <div>
                    <button th:id="'submit' + ${factor.id}" type="submit" name="user_mfa_enrollment" value="true" class="button primary" th:text="#{mfa_enroll.button.submit}"></button>
                </div>
                <div>
                    <button type="submit" name="user_mfa_enrollment" value="false" class="button secondary" th:text="#{mfa_enroll.button.skip}"></button>
                </div>
            </form>

            <div class="section">
                <a class="left-arrow" href="#"><span class="icons">arrow_back</span><span th:text="#{mfa_enroll.button.back}"/></a>
            </div>

        </div>
        <div th:if="${factor.factorType == 'EMAIL'}" id="email" class="section">
            <form role="form" th:id="${factor.id}" th:action="${action}" method="post" class="enrollment-card">
                <span class="enrollment-card-label" th:text="#{mfa.email}"/>
                <span class="enrollment-card-description" th:text="#{mfa_enroll.email}"/>

                <input class="input-field" th:id="'emailFact' + ${factIter.index}" type="email" th:name="'emailFact' + ${factIter.index}" th:value="${emailAddress}"
                       placeholder="Email">

                <div th:id="'invalidemailFact' + ${factIter.index}" class="button error-text">
                    <span class="description">
                        <span class="error" th:text="${error}"></span>
                        <small th:text="#{mfa_enroll.email.invalid}"/>
                    </span>
                </div>

                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <input type="hidden" th:name="factorId" th:value="${factor.id}"/>
                <input type="hidden" th:id="'sharedSecret' + ${factIter.index}" th:name="'sharedSecret' + ${factIter.index}" th:value="${factor.enrollment.key}"/>
                <input type="hidden" id="email" name="email" value=""/>
                <input type="hidden" id="sharedSecret" name="sharedSecret" value=""/>

                <div>
                    <button th:id="'submit' + ${factor.id}" type="submit" name="user_mfa_enrollment" value="true" class="button primary" th:text="#{mfa_enroll.button.submit}"></button>
                </div>
                <div>
                    <button type="submit" name="user_mfa_enrollment" value="false" class="button secondary" th:text="#{mfa_enroll.button.skip}"></button>
                </div>
            </form>

            <div class="section">
                <a class="left-arrow" href="#"><span class="icons">arrow_back</span><span th:text="#{mfa_enroll.button.back}"/></a>
            </div>
        </div>
        <div th:if="${factor.factorType == 'HTTP'}" id="http" class="section">
            <form role="form" th:id="${factor.id}" th:action="${action}" method="post" class="enrollment-card">
                <span class="enrollment-card-label" th:text="#{mfa.http}"/>
                <span class="enrollment-card-description" th:text="#{mfa_enroll.http}"></span>

                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <input type="hidden" th:name="factorId" th:value="${factor.id}"/>
                <div>
                    <button type="submit" name="user_mfa_enrollment" value="true" class="button primary" th:text="#{mfa_enroll.button.submit}"></button>
                </div>
                <div>
                    <button type="submit" name="user_mfa_enrollment" value="false" class="button secondary" th:text="#{mfa_enroll.button.skip}"></button>
                </div>
            </form>

            <div class="section">
                <a class="left-arrow" href="#"><span class="icons">arrow_back</span><span th:text="#{mfa_enroll.button.back}"/></a>
            </div>

        </div>
        <div th:if="${factor.factorType == 'FIDO2'}" id="fido2" class="section">
            <form role="form" th:id="${factor.id}" th:action="${action}" method="post" class="enrollment-card">
                <span class="enrollment-card-label" th:text="#{mfa.fido}"/>
                <span class="enrollment-card-description" th:text="#{mfa_enroll.fido}"/>

                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <input type="hidden" th:name="factorId" th:value="${factor.id}"/>
                <div>
                    <button th:id="'submit' + ${factor.id}" type="submit" name="user_mfa_enrollment" value="true" class="button primary" th:text="#{mfa_enroll.button.submit}"></button>
                </div>
                <div>
                    <button type="submit" name="user_mfa_enrollment" value="false" class="button secondary" th:text="#{mfa_enroll.button.skip}"></button>
                </div>
            </form>

            <div class="section">
                <a class="left-arrow" href="#"><span class="icons">arrow_back</span><span th:text="#{mfa_enroll.button.back}"/></a>
            </div>

        </div>
    </div>
</div>
<!--[if lt IE 10]>
<script th:src="@{assets/js/placeholder.js}"></script>
<![endif]-->
<script th:src="@{../assets/material/material.min.js}"></script>
<script th:src="@{../assets/js/jquery-3.5.1.min.js}"></script>
<script th:src="@{../assets/js/intl-tel-input-17.0.8.min.js}"></script>
<script th:inline="javascript" th:attr="nonce=${script_inline_nonce}">
    /*<![CDATA[*/

    const intlFields = {};

    function hideError(eltId) {
        $("#invalid" + eltId).hide();
    }

    function checkPhoneNumber(event, factor, eltId) {
        const phoneInput = intlFields[eltId];
        const phoneNumber = phoneInput.getNumber();

        // intl-tel-input validity check, Requires plugin updates for updates on phone number validity
        if (phoneInput.isValidNumber()) {
            $("#invalid" + eltId).hide();
            $("#" + factor).find('#phone')[0].value = phoneNumber;
            $("#" + factor).submit();
        } else {
            // do not submit form in case of wrong number
            event.preventDefault();
            $("#invalid" + eltId).show();
        }
    }

    function assignSharedSecret(factor, eltId) {
        const sharedSecret = $("#" + eltId);
        $("#" + factor).find('#sharedSecret')[0].value = sharedSecret.val();
        $("#" + factor).submit();
    }

    function checkEmail(event, factor, eltId, sharedSecretId) {
        const emailInput = $("#" + eltId);
        const sharedSecret = $("#" + sharedSecretId);

        if (emailInput.val() != null) {
            hideError(eltId);
            $("#" + factor).find('#email')[0].value = emailInput.val();
            $("#" + factor).find('#sharedSecret')[0].value = sharedSecret.val();
            $("#" + factor).submit();
        } else {
            // do not submit form in case of wrong number
            event.preventDefault();
            $("#invalid" + eltId).show();
        }
    }

    $(document).ready(function () {
        function initializeIntlTelInput(eltId, countries) {
            // hide the invalid phone number message
            hideError(eltId);

            // Handle international prefixes, format phone input field
            // Uses intl-tel-input plugin
            const phoneInputField = document.querySelector("#" + eltId);
            const phoneInput = window.intlTelInput(phoneInputField, {
                autoPlaceholder: "off",
                dropdownContainer: document.body,
                onlyCountries: countries,
                utilsScript: "../assets/js/intl-tel-input-17.0.8-utils.js",
            });
            return phoneInput;
        }

        /*[# th:each="factor,factIter: ${factors}"]*/
        if ([[${factor.factorType}]] == 'SMS' || [[${factor.factorType}]] == 'CALL') {
            intlFields['phoneFact' +/*[[${factIter.index}]]*/] = initializeIntlTelInput("phoneFact" +/*[[${factIter.index}]]*/, /*[[${factor.enrollment.countries}]]*/);
            $("#submit" +/*[[${factor.id}]]*/).click((event) => {
                checkPhoneNumber(event, /*[[${factor.id}]]*/, 'phoneFact' + /*[[${factIter.index}]]*/);
            });

            $("#phoneFact" + /*[[${factIter.index}]]*/).keydown((event) => {
                hideError('phoneFact' + /*[[${factIter.index}]]*/);
            });
        }

        if ([[${factor.factorType}]] == 'EMAIL') {
            hideError("emailFact" +/*[[${factIter.index}]]*/);
            $("#submit" +/*[[${factor.id}]]*/).click((event) => {
                checkEmail(event, /*[[${factor.id}]]*/, 'emailFact' + /*[[${factIter.index}]]*/, 'sharedSecret' + /*[[${factIter.index}]]*/);
            });

            $("#emailFact" + /*[[${factIter.index}]]*/).keydown((event) => {
                hideError('emailFact' + /*[[${factIter.index}]]*/);
            });
        }

        if ([[${factor.factorType}]] == 'TOTP') {
            $("#submit" +/*[[${factor.id}]]*/).click(() => {
                assignSharedSecret(/*[[${factor.id}]]*/, 'sharedSecret' + /*[[${factIter.index}]]*/);
            });
        }
        /*[/]*/


        const nextBtn = $("#next");
        nextBtn.prop('disabled', true);
        nextBtn.addClass("button-disabled")

        const $radioButtons = $("input:radio");
        let selectedItem;
        $radioButtons.on("click", function () {
            const $selected = $(this);
            selectedItem = $selected.attr('name');
            $radioButtons.each(function () {
                if ($(this).attr('name') !== selectedItem) {
                    $(this).prop('checked', false);
                } else {
                    $('.radio-card').removeClass('active');

                    const selectedCard = $selected.closest('.radio-card');
                    selectedCard.addClass('active');
                }
            });

            nextBtn.prop('disabled', false);
            nextBtn.removeClass("button-disabled")
        });

        /*<![CDATA[*/
        const title=/*[[#{mfa_enroll.on.select.title}]]*/ '';
        const description=/*[[#{mfa_enroll.on.select.description}]]*/ '';
        nextBtn.on("click", function () {
            $("#enrollments").hide();
            $(".hide-enrollment-item").hide();

            $("#enrollment-title").text(title);
            $("#enrollment-description").text(description);

            $("#" + selectedItem).parent().show();
        });
        /*]]>*/

        $('.left-arrow').on('click', function (){
            $(".hide-enrollment-item").hide();
            $(".card-section").show();
        });
    });

    /*]]>*/
</script>
</body>
</html>
